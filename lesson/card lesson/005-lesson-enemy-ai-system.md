# บทเรียนที่ 005: ระบบ AI ศัตรู (Enemy AI System)

## วัตถุประสงค์ (Objectives)
เรียนรู้การสร้างพฤติกรรม AI ที่ชาญฉลาดสำหรับศัตรูในระบบต่อสู้แบบการ์ด

## ภาพรวมระบบ (System Overview)

ระบบ AI ศัตรูจะประกอบด้วย:
- การตัดสินใจเลือกการ์ด
- การวิเคราะห์สถานการณ์
- การปรับระดับความยาก
- การเล่นการ์ดอย่างมีกลยุทธ์

## ระดับความยาก AI (AI Difficulty Levels)

### 1. AI แบบง่าย (Easy AI)
- เล่นการ์ดแบบสุ่ม
- ไม่วิเคราะห์สถานการณ์

### 2. AI แบบกลาง (Medium AI)
- เลือกการ์ดตามสถานการณ์
- พิจารณาพลังชีวิตและมานา

### 3. AI แบบยาก (Hard AI)
- วางแผนหลายเทิร์นล่วงหน้า
- ใช้การ์ดอย่างมีประสิทธิภาพสูงสุด

## การติดตั้งใช้งาน (Implementation)

### 1. EnemyAI.cs - ระบบ AI หลัก

```csharp
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

public class EnemyAI : MonoBehaviour
{
    [Header("การอ้างอิง - References")]
    public BattleManager battleManager;     // ผู้จัดการการต่อสู้
    public CardManager cardManager;         // ผู้จัดการการ์ด

    [Header("การตั้งค่า AI - AI Settings")]
    public AIDifficulty ความยากAI = AIDifficulty.กลาง;
    public int จำนวนเทิร์นที่คาดการณ์ล่วงหน้า = 2; // สำหรับ Hard AI

    [Header("สถานะ AI - AI Status")]
    public List<CardData> มือของศัตรู;         // มือการ์ดของศัตรู
    private System.Random random = new System.Random();

    /// <summary>
    /// ระดับความยากของ AI
    /// AI difficulty levels
    /// </summary>
    public enum AIDifficulty
    {
        ง่าย,    // สุ่มการ์ด
        กลาง,    // เลือกการ์ดตามสถานการณ์
        ยาก     // วางแผนล่วงหน้า
    }

    void Start()
    {
        มือของศัตรู = new List<CardData>();
        จั่วมือเริ่มต้น();
    }

    /// <summary>
    /// จั่วมือเริ่มต้นสำหรับศัตรู
    /// Draw initial hand for enemy
    /// </summary>
    public void จั่วมือเริ่มต้น()
    {
        if (cardManager == null) return;

        มือของศัตรู.Clear();

        // จั่ว 5 การ์ดสำหรับศัตรู
        for (int i = 0; i < 5; i++)
        {
            CardData การ์ดใหม่ = cardManager.สุ่มการ์ด();
            if (การ์ดใหม่ != null)
            {
                มือของศัตรู.Add(การ์ดใหม่);
            }
        }

        Debug.Log($"ศัตรูจั่วการ์ดแล้ว {มือของศัตรู.Count} ใบ");
    }

    /// <summary>
    /// จั่วการ์ดใหม่สำหรับศัตรู
    /// Draw new card for enemy
    /// </summary>
    public void จั่วการ์ด()
    {
        if (cardManager != null && มือของศัตรู.Count < 7)
        {
            CardData การ์ดใหม่ = cardManager.สุ่มการ์ด();
            if (การ์ดใหม่ != null)
            {
                มือของศัตรู.Add(การ์ดใหม่);
                Debug.Log($"ศัตรูจั่วการ์ด: {การ์ดใหม่.ชื่อการ์ด}");
            }
        }
    }

    /// <summary>
    /// เล่นเทิร์นของศัตรู
    /// Play enemy's turn
    /// </summary>
    public void เล่นเทิร์นศัตรู()
    {
        if (battleManager == null || มือของศัตรู.Count == 0) return;

        Debug.Log($"=== เทิร์นของศัตรู ({ความยากAI}) ===");

        switch (ความยากAI)
        {
            case AIDifficulty.ง่าย:
                เล่นเทิร์นแบบง่าย();
                break;
            case AIDifficulty.กลาง:
                เล่นเทิร์นแบบกลาง();
                break;
            case AIDifficulty.ยาก:
                เล่นเทิร์นแบบยาก();
                break;
        }
    }

    /// <summary>
    /// เล่นเทิร์นแบบง่าย - สุ่มการ์ด
    /// Easy turn - random card play
    /// </summary>
    private void เล่นเทิร์นแบบง่าย()
    {
        // สุ่มการ์ดจากมือที่มีมานาพอ
        List<CardData> การ์ดที่สามารถเล่นได้ = มือของศัตรู
            .Where(card => battleManager.ศัตรู.มานาปัจจุบัน >= card.ค่าใช้มานา)
            .ToList();

        if (การ์ดที่สามารถเล่นได้.Count > 0)
        {
            CardData การ์ดที่เลือก = การ์ดที่สามารถเล่นได้[random.Next(การ์ดที่สามารถเล่นได้.Count)];
            เล่นการ์ดที่เลือก(การ์ดที่เลือก);
        }
        else
        {
            Debug.Log("ศัตรูไม่มีมานาเล่นการ์ด - จบเทิร์น");
        }

        จบเทิร์น();
    }

    /// <summary>
    /// เล่นเทิร์นแบบกลาง - เลือกการ์ดตามสถานการณ์
    /// Medium turn - situational card selection
    /// </summary>
    private void เล่นเทิร์นแบบกลาง()
    {
        // วิเคราะห์สถานการณ์
        AISituation สถานการณ์ = วิเคราะห์สถานการณ์();

        // เลือกกลยุทธ์ตามสถานการณ์
        List<CardData> การ์ดที่เหมาะสม = เลือกการ์ดตามกลยุทธ์(สถานการณ์);

        if (การ์ดที่เหมาะสม.Count > 0)
        {
            CardData การ์ดที่ดีที่สุด = เลือกการ์ดที่ดีที่สุด(การ์ดที่เหมาะสม, สถานการณ์);
            เล่นการ์ดที่เลือก(การ์ดที่ดีที่สุด);
        }
        else
        {
            Debug.Log("ศัตรูไม่มีกลยุทธ์ที่เหมาะสม - จบเทิร์น");
        }

        จบเทิร์น();
    }

    /// <summary>
    /// เล่นเทิร์นแบบยาก - วางแผนล่วงหน้า
    /// Hard turn - plan ahead
    /// </summary>
    private void เล่นเทิร์นแบบยาก()
    {
        // คาดการณ์สถานการณ์ในอนาคต
        List<AIFutureState> สถานการณ์ในอนาคต = คาดการณ์สถานการณ์();

        // เลือกการ์ดที่ให้ผลดีที่สุดในระยะยาว
        CardData การ์ดที่ดีที่สุด = เลือกการ์ดที่ดีที่สุดในระยะยาว(สถานการณ์ในอนาคต);

        if (การ์ดที่ดีที่สุด != null)
        {
            เล่นการ์ดที่เลือก(การ์ดที่ดีที่สุด);
        }
        else
        {
            Debug.Log("ศัตรูไม่พบกลยุทธ์ที่ดี - จบเทิร์น");
        }

        จบเทิร์น();
    }

    /// <summary>
    /// วิเคราะห์สถานการณ์ปัจจุบัน
    /// Analyze current situation
    /// </summary>
    private AISituation วิเคราะห์สถานการณ์()
    {
        AISituation สถานการณ์ = new AISituation();

        // วิเคราะห์พลังชีวิต
        float อัตราพลังชีวิตผู้เล่น = (float)battleManager.ผู้เล่น.พลังชีวิตปัจจุบัน / battleManager.ผู้เล่น.พลังชีวิตสูงสุด;
        float อัตราพลังชีวิตศัตรู = (float)battleManager.ศัตรู.พลังชีวิตปัจจุบัน / battleManager.ศัตรู.พลังชีวิตสูงสุด;

        สถานการณ์.ผู้เล่นมีพลังชีวิตน้อยกว่า = อัตราพลังชีวิตผู้เล่น < 0.3f;
        สถานการณ์.ศัตรูมีพลังชีวิตน้อยกว่า = อัตราพลังชีวิตศัตรู < 0.3f;
        สถานการณ์.ศัตรูได้เปรียบด้านพลังชีวิต = อัตราพลังชีวิตศัตรู > อัตราพลังชีวิตผู้เล่น + 0.2f;

        // วิเคราะห์มานา
        สถานการณ์.มีมานาพอสำหรับการ์ดพิเศษ = battleManager.ศัตรู.มานาปัจจุบัน >= 5;
        สถานการณ์.ผู้เล่นมีมานาเยอะ = battleManager.ผู้เล่น.มานาปัจจุบัน > battleManager.ศัตรู.มานาปัจจุบัน + 2;

        // วิเคราะห์มือการ์ด
        สถานการณ์.มีการ์ดโจมตีในมือ = มือของศัตรู.Any(card => card.ประเภท == ประเภทการ์ด.ตัวเลข);
        สถานการณ์.มีการ์ดป้องกันในมือ = มือของศัตรู.Any(card => card.ประเภท == ประเภทการ์ด.ช่วยเหลือ);

        return สถานการณ์;
    }

    /// <summary>
    /// เลือกการ์ดตามกลยุทธ์
    /// Select cards based on strategy
    /// </summary>
    private List<CardData> เลือกการ์ดตามกลยุทธ์(AISituation สถานการณ์)
    {
        List<CardData> การ์ดที่เหมาะสม = new List<CardData>();

        foreach (CardData card in มือของศัตรู)
        {
            if (battleManager.ศัตรู.มานาปัจจุบัน < card.ค่าใช้มานา)
                continue; // มานาไม่พอ

            bool เหมาะสม = false;

            // กลยุทธ์ตามประเภทการ์ดและสถานการณ์
            switch (card.ประเภท)
            {
                case ประเภทการ์ด.ตัวเลข:
                    // โจมตีเมื่อศัตรูได้เปรียบหรือผู้เล่นอ่อนแอ
                    เหมาะสม = สถานการณ์.ศัตรูได้เปรียบด้านพลังชีวิต || สถานการณ์.ผู้เล่นมีพลังชีวิตน้อยกว่า;
                    break;

                case ประเภทการ์ด.ช่วยเหลือ:
                    // รักษาเมื่อพลังชีวิตต่ำ หรือเพิ่มมานาเมื่อต้องการ
                    เหมาะสม = สถานการณ์.ศัตรูมีพลังชีวิตน้อยกว่า ||
                              (card.จำนวนเพิ่มมานา > 0 && สถานการณ์.มีมานาพอสำหรับการ์ดพิเศษ);
                    break;

                case ประเภทการ์ด.กับดัก:
                    // วางกับดักเมื่อผู้เล่นมีพลังชีวิตเหลือน้อย
                    เหมาะสม = สถานการณ์.ผู้เล่นมีพลังชีวิตน้อยกว่า;
                    break;

                case ประเภทการ์ด.ตัวดำเนินการ:
                case ประเภทการ์ด.สลับสมการ:
                    // ใช้เมื่อมีตัวเลขในมือและต้องการเพิ่มความแรง
                    เหมาะสม = สถานการณ์.มีการ์ดโจมตีในมือ && สถานการณ์.มีมานาพอสำหรับการ์ดพิเศษ;
                    break;
            }

            if (เหมาะสม)
            {
                การ์ดที่เหมาะสม.Add(card);
            }
        }

        return การ์ดที่เหมาะสม;
    }

    /// <summary>
    /// เลือกการ์ดที่ดีที่สุดจากกลุ่มที่เหมาะสม
    /// Select best card from suitable cards
    /// </summary>
    private CardData เลือกการ์ดที่ดีที่สุด(List<CardData> การ์ดที่เหมาะสม, AISituation สถานการณ์)
    {
        if (การ์ดที่เหมาะสม.Count == 0) return null;

        // เรียงตามลำดับความสำคัญ
        return การ์ดที่เหมาะสม.OrderByDescending(card => คำนวณคะแนนการ์ด(card, สถานการณ์)).First();
    }

    /// <summary>
    /// คำนวณคะแนนความสำคัญของการ์ด
    /// Calculate card priority score
    /// </summary>
    private float คำนวณคะแนนการ์ด(CardData card, AISituation สถานการณ์)
    {
        float คะแนน = 0f;

        switch (card.ประเภท)
        {
            case ประเภทการ์ด.ตัวเลข:
                คะแนน = card.ค่าตัวเลข * 2f; // ยิ่งตัวเลขมากยิ่งดี
                if (สถานการณ์.ผู้เล่นมีพลังชีวิตน้อยกว่า) คะแนน *= 1.5f; // โบนัสเมื่อผู้เล่นอ่อนแอ
                break;

            case ประเภทการ์ด.ช่วยเหลือ:
                if (card.จำนวนรักษา > 0) คะแนน = card.จำนวนรักษา * 3f; // การรักษาสำคัญมาก
                if (card.จำนวนเพิ่มมานา > 0) คะแนน = card.จำนวนเพิ่มมานา * 2f; // เพิ่มมานาสำคัญ
                break;

            case ประเภทการ์ด.กับดัก:
                คะแนน = card.ความเสียหายกับดัก * 1.5f; // กับดักมีประสิทธิภาพสูง
                break;

            case ประเภทการ์ด.ตัวดำเนินการ:
            case ประเภทการ์ด.สลับสมการ:
                คะแนน = 5f; // ตัวดำเนินการมีประโยชน์ในระยะยาว
                break;
        }

        // เพิ่มคะแนนตามมานาที่ใช้ (ใช้มานาน้อยดีกว่า)
        คะแนน += (10f - card.ค่าใช้มานา);

        return คะแนน;
    }

    /// <summary>
    /// เล่นการ์ดที่เลือก
    /// Play selected card
    /// </summary>
    private void เล่นการ์ดที่เลือก(CardData cardData)
    {
        // แปลง CardData เป็น Card และเล่น
        Card การ์ดที่เล่นได้ = cardData.แปลงเป็นการ์ด();

        if (battleManager.เล่นการ์ดศัตรู(การ์ดที่เล่นได้))
        {
            มือของศัตรู.Remove(cardData);
            Debug.Log($"ศัตรูเล่นการ์ด: {cardData.ชื่อการ์ด}");
        }
    }

    /// <summary>
    /// จบเทิร์นของศัตรู
    /// End enemy's turn
    /// </summary>
    private void จบเทิร์น()
    {
        // จบเทิร์นใน BattleManager
        if (battleManager != null)
        {
            battleManager.จบเทิร์น();
        }
    }
}

/// <summary>
/// สถานการณ์สำหรับการวิเคราะห์ AI
/// Situation for AI analysis
/// </summary>
public class AISituation
{
    public bool ผู้เล่นมีพลังชีวิตน้อยกว่า;
    public bool ศัตรูมีพลังชีวิตน้อยกว่า;
    public bool ศัตรูได้เปรียบด้านพลังชีวิต;
    public bool มีมานาพอสำหรับการ์ดพิเศษ;
    public bool ผู้เล่นมีมานาเยอะ;
    public bool มีการ์ดโจมตีในมือ;
    public bool มีการ์ดป้องกันในมือ;
}

/// <summary>
/// สถานการณ์ในอนาคตสำหรับ Hard AI
/// Future state for Hard AI
/// </summary>
public class AIFutureState
{
    public BattleUnit ผู้เล่นในอนาคต;
    public BattleUnit ศัตรูในอนาคต;
    public float คะแนนสถานการณ์;
}
```

### 2. BattleManager Extensions

```csharp
// เพิ่มใน BattleManager.cs
public bool เล่นการ์ดศัตรู(Card การ์ด)
{
    // ตรวจสอบมานา
    if (ศัตรู.มานาปัจจุบัน < การ์ด.ค่าใช้มานา)
        return false;

    // ใช้มานาและเล่นการ์ด
    ศัตรู.ใช้มานา(การ์ด.ค่าใช้มานา);
    การ์ด.เล่นการ์ด(ศัตรู, ผู้เล่น);

    return true;
}
```

## กลยุทธ์ AI ขั้นสูง (Advanced AI Strategies)

### 1. การคาดการณ์สถานการณ์ (Situation Prediction)

```csharp
private List<AIFutureState> คาดการณ์สถานการณ์()
{
    List<AIFutureState> สถานการณ์ที่เป็นไปได้ = new List<AIFutureState>();

    // คาดการณ์สถานการณ์หลังจากเล่นการ์ดแต่ละใบ
    foreach (CardData card in มือของศัตรู)
    {
        if (ศัตรู.มานาปัจจุบัน >= card.ค่าใช้มานา)
        {
            AIFutureState สถานการณ์ใหม่ = สร้างสถานการณ์หลังเล่นการ์ด(card);
            สถานการณ์ที่เป็นไปได้.Add(สถานการณ์ใหม่);
        }
    }

    return สถานการณ์ที่เป็นไปได้;
}

private AIFutureState สร้างสถานการณ์หลังเล่นการ์ด(CardData card)
{
    // คัดลอกสถานการณ์ปัจจุบัน
    AIFutureState สถานการณ์ใหม่ = new AIFutureState();

    // คำนวณผลลัพธ์หลังจากเล่นการ์ด
    // ... (การคำนวณที่ซับซ้อน)

    return สถานการณ์ใหม่;
}
```

### 2. การปรับระดับความยาก (Difficulty Scaling)

```csharp
public void ตั้งความยากAI(AIDifficulty ความยาก)
{
    ความยากAI = ความยาก;

    // ปรับพารามิเตอร์ตามระดับความยาก
    switch (ความยาก)
    {
        case AIDifficulty.ง่าย:
            จำนวนเทิร์นที่คาดการณ์ล่วงหน้า = 0;
            break;
        case AIDifficulty.กลาง:
            จำนวนเทิร์นที่คาดการณ์ล่วงหน้า = 1;
            break;
        case AIDifficulty.ยาก:
            จำนวนเทิร์นที่คาดการณ์ล่วงหน้า = 3;
            break;
    }
}
```

## การทดสอบ AI (AI Testing)

### การตั้งค่าในซีน (Scene Setup)

1. **สร้าง EnemyAI** ในซีน
2. **กำหนด BattleManager และ CardManager**
3. **ตั้งระดับความยาก**
4. **ทดสอบพฤติกรรม**

### การสังเกตพฤติกรรม (Behavior Observation)

- **Easy AI**: เล่นการ์ดแบบสุ่ม
- **Medium AI**: เลือกการ์ดตามสถานการณ์
- **Hard AI**: วางแผนระยะยาว

## ข้อควรพิจารณา (Considerations)

### ✅ จุดแข็งของระบบนี้
- **ปรับแต่งได้** - เปลี่ยนระดับความยากง่าย
- **มีกลยุทธ์** - เล่นตามสถานการณ์จริง
- **ขยายได้** - เพิ่มกฎกลยุทธ์ใหม่ได้

### ⚠️ ข้อควรระวัง
- **สมดุล** - AI ต้องไม่เก่งหรืออ่อนเกินไป
- **ประสิทธิภาพ** - การคำนวณที่ซับซ้อนอาจทำให้เกมช้า
- **คาดเดาได้** - ผู้เล่นต้องรู้สึกว่าต่อสู้กับ AI ที่ฉลาด

## แบบฝึกหัด (Exercise)

1. **สร้าง Easy AI** ที่เล่นการ์ดแบบสุ่ม
2. **สร้าง Medium AI** ที่วิเคราะห์สถานการณ์
3. **สร้าง Hard AI** ที่วางแผนล่วงหน้า
4. **ทดสอบสมดุล** ของแต่ละระดับความยาก

**คุณเข้าใจระบบ AI ศัตรูนี้ในระดับไหน (1-3)?**

เมื่อพร้อม เราจะไปเรียนเรื่อง Math Equation System กันต่อ! 🚀
